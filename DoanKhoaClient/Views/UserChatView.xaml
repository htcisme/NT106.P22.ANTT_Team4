<Window
    x:Class="DoanKhoaClient.Views.UserChatView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:DoanKhoaClient.Views"
    xmlns:vm="clr-namespace:DoanKhoaClient.ViewModels"
    xmlns:converters="clr-namespace:DoanKhoaClient.Converters"
    Title="Chat"
    WindowStartupLocation="CenterScreen"
    WindowState="Maximized"
    MinWidth="1024"
    MinHeight="768"
    mc:Ignorable="d">


    <!-- Khai báo Converters -->
    <Window.Resources>
        <converters:TimeZoneConverter x:Key="TimeZoneConverter"/>

        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:StringToBoolConverter x:Key="StringToBoolConverter"/>
        <converters:CurrentUserConverter x:Key="CurrentUserConverter"/>
        <converters:NotCurrentUserConverter x:Key="NotCurrentUserConverter"/>
        <converters:AttachmentTypeToVisibilityConverter x:Key="AttachmentTypeToVisibilityConverter"/>
        <converters:MessageTypeToVisibilityConverter x:Key="MessageTypeToVisibilityConverter"/>
        <converters:FileIconConverter x:Key="FileIconConverter"/>
        <converters:FileSizeConverter x:Key="FileSizeConverter"/>
        <converters:ConversationTitleConverter x:Key="ConversationTitleConverter"/>
        <!-- Thêm Style này vào Window.Resources -->
        <Style x:Key="MenuItemStyle"
               TargetType="{x:Type StackPanel}">
            <Setter Property="Cursor"
                    Value="Hand"/>
            <Setter Property="RenderTransformOrigin"
                    Value="0.5,0.5"/>
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <TransformGroup>
                        <ScaleTransform ScaleX="1"
                                        ScaleY="1"/>
                        <TranslateTransform/>
                    </TransformGroup>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                To="1.05"
                                Duration="0:0:0.1"/>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                To="1.05"
                                Duration="0:0:0.1"/>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(TranslateTransform.X)"
                                To="3"
                                Duration="0:0:0.1"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                To="1"
                                Duration="0:0:0.1"/>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                To="1"
                                Duration="0:0:0.1"/>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(TranslateTransform.X)"
                                To="0"
                                Duration="0:0:0.1"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SendButtonStyle"
               TargetType="{x:Type Button}">
            <Setter Property="Background"
                    Value="Transparent"/>
            <Setter Property="BorderThickness"
                    Value="0"/>
            <Setter Property="Cursor"
                    Value="Hand"/>
            <Setter Property="RenderTransformOrigin"
                    Value="0.5,0.5"/>
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1"
                                    ScaleY="1"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                             To="1.2"
                                             Duration="0:0:0.1"/>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                             To="1.2"
                                             Duration="0:0:0.1"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                             To="1"
                                             Duration="0:0:0.1"/>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                             To="1"
                                             Duration="0:0:0.1"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="PreviewMouseDown">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                             To="0.9"
                                             Duration="0:0:0.05"/>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                             To="0.9"
                                             Duration="0:0:0.05"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="PreviewMouseUp">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                             To="1.2"
                                             Duration="0:0:0.05"/>
                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                             To="1.2"
                                             Duration="0:0:0.05"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Window.DataContext>
        <vm:UserChatViewModel/>
    </Window.DataContext>
    <Window.Triggers>
        <EventTrigger RoutedEvent="Window.Loaded">
            <BeginStoryboard>
                <Storyboard>
                    <!-- Sửa lỗi bằng cách thêm Storyboard.TargetName cho animation opacity -->
                    <DoubleAnimation
                        Storyboard.TargetName="Chat_Background"
                        Storyboard.TargetProperty="Opacity"
                        From="0"
                        To="1"
                        Duration="0:0:0.5"/>
                    <ThicknessAnimation
                        Storyboard.TargetName="Chat_Background"
                        Storyboard.TargetProperty="Margin"
                        From="0,30,0,0"
                        To="0,0,0,0"
                        Duration="0:0:0.5">
                        <ThicknessAnimation.EasingFunction>
                            <QuadraticEase EasingMode="EaseOut"/>
                        </ThicknessAnimation.EasingFunction>
                    </ThicknessAnimation>
                </Storyboard>
            </BeginStoryboard>
        </EventTrigger>
    </Window.Triggers>
    <Grid x:Name="Chat_Background"
          Opacity="0">

        <Grid.Background>
            <LinearGradientBrush StartPoint="0.5,0"
                                 EndPoint="0.5,1">
                <GradientStop Offset="0.67"
                              Color="#FFF6FCFF"/>
                <GradientStop Offset="1"
                              Color="#FFDBF3FF"/>
            </LinearGradientBrush>
        </Grid.Background>

        <Viewbox Stretch="Uniform"
                 MaxHeight="{Binding ActualHeight, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Window}}}"
                 MaxWidth="{Binding ActualWidth, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Window}}}">
            <Grid Width="1440"
                  Height="1024">
                <!-- Search Box -->
                <TextBox x:Name="UserChat_tbSearch1"
                         HorizontalAlignment="Left"
                         Margin="370,41,0,0"
                         TextWrapping="Wrap"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         VerticalAlignment="Top"
                         Width="307"
                         Height="50"
                         Background="#FFDBF3FF"
                         BorderBrush="{x:Null}"/>

                <!-- Left Dashboard -->
                <Border x:Name="UserChat_Dashboard1"
                        BorderBrush="Black"
                        HorizontalAlignment="Left"
                        Height="942"
                        Margin="43,40,0,0"
                        VerticalAlignment="Top"
                        Width="288"
                        CornerRadius="10,10,10,10">
                    <Grid>
                        <Grid.Background>
                            <LinearGradientBrush EndPoint="0.5,1"
                                                 StartPoint="0.5,0">
                                <GradientStop Color="#FFF6FCFF"
                                              Offset="0.04"/>
                                <GradientStop Color="#FFDBF3FF"
                                              Offset="0.46"/>
                                <GradientStop Color="#FF87ACCD"
                                              Offset="0.937"/>
                            </LinearGradientBrush>
                        </Grid.Background>

                        <!-- Logo và menu -->
                    </Grid>
                </Border>

                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Margin="102,203,0,0"
                            VerticalAlignment="Top"
                            Style="{StaticResource MenuItemStyle}">
                    <Image Height="30"
                           Width="30"
                           Source="/Views/Images/home.png"/>
                    <Label Content="Home"
                           Height="30"
                           Width="108"
                           FontFamily="Segoe UI"
                           FontSize="20"
                           FontWeight="Bold"
                           Margin="33,0,0,0"
                           Padding="0,0,0,0"/>
                </StackPanel>

                <!-- Chat Menu Item -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Margin="102,279,0,0"
                            VerticalAlignment="Top"
                            Style="{StaticResource MenuItemStyle}">
                    <Image Height="30"
                           Width="30"
                           Source="/Views/Images/chat_bubble.png"/>
                    <Label Content="Chat"
                           Height="30"
                           Width="108"
                           FontFamily="Segoe UI"
                           FontSize="20"
                           FontWeight="Bold"
                           Margin="33,0,0,0"
                           Padding="0,0,0,0"
                           Foreground="#597CA2"/>
                </StackPanel>

                <!-- Activities Menu Item -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Margin="102,354,0,0"
                            VerticalAlignment="Top"
                            Style="{StaticResource MenuItemStyle}">
                    <Image Height="30"
                           Width="30"
                           Source="/Views/Images/activities.png"/>
                    <Label Content="Activities"
                           Height="30"
                           Width="108"
                           FontFamily="Segoe UI"
                           FontSize="20"
                           FontWeight="Bold"
                           Margin="33,0,0,0"
                           Padding="0,0,0,0"/>
                </StackPanel>

                <!-- Members Menu Item -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Margin="102,432,0,0"
                            VerticalAlignment="Top"
                            Style="{StaticResource MenuItemStyle}">
                    <Image Height="30"
                           Width="30"
                           Source="/Views/Images/members.png"/>
                    <Label Content="Members"
                           Height="30"
                           Width="108"
                           FontFamily="Segoe UI"
                           FontSize="20"
                           FontWeight="Bold"
                           Margin="33,0,0,0"
                           Padding="0,0,0,0"/>
                </StackPanel>

                <!-- Tasks Menu Item -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Margin="102,510,0,0"
                            VerticalAlignment="Top"
                            Style="{StaticResource MenuItemStyle}">
                    <Image Height="30"
                           Width="30"
                           Source="/Views/Images/active-tasks.png"/>
                    <Label Content="Tasks"
                           Height="30"
                           Width="108"
                           FontFamily="Segoe UI"
                           FontSize="20"
                           FontWeight="Bold"
                           Margin="33,0,0,0"
                           Padding="0,0,0,0"/>
                </StackPanel>
                <Image x:Name="Task_iLogo"
                       HorizontalAlignment="Left"
                       Height="40"
                       Margin="131,71,0,0"
                       VerticalAlignment="Top"
                       Width="112.38"
                       Source="/Views/Images/header.png"/>
                <!-- Social Media Icons -->
                <Image x:Name="GroupTask_Design_iFacebook"
                       HorizontalAlignment="Left"
                       Height="24"
                       Margin="175,926,0,0"
                       VerticalAlignment="Top"
                       Width="24"
                       Source="/Views/Images/facebook.png"/>
                <Image x:Name="GroupTask_Design_iInstagram"
                       HorizontalAlignment="Left"
                       Height="24"
                       Margin="135,926,0,0"
                       VerticalAlignment="Top"
                       Width="24"
                       Source="/Views/Images/instagram.png"/>
                <Image x:Name="GroupTask_Design_iYoutube"
                       HorizontalAlignment="Left"
                       Height="24"
                       Margin="215,926,0,0"
                       VerticalAlignment="Top"
                       Width="24"
                       Source="/Views/Images/youtube.png"/>
                <!-- Top Icons -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Margin="0,46,40,0">
                    <Image x:Name="ThemeToggleButton"
                           Height="40"
                           Width="40"
                           Source="/Views/Images/dark.png"
                           Margin="0,0,20,0"
                           MouseDown="ThemeToggleButton_MouseDown"/>
                    <Image Height="40"
                           Width="40"
                           Source="/Views/Images/light-notifications.png"
                           Margin="0,0,20,0"/>
                    <Image Height="40"
                           Width="40"
                           Source="/Views/Images/generic avatar.png"/>
                </StackPanel>

                <Image HorizontalAlignment="Left"
                       Height="40"
                       Margin="628,46,0,0"
                       VerticalAlignment="Top"
                       Width="40"
                       Source="/Views/Images/search.png"/>



                <Border HorizontalAlignment="Left"
                        Height="864"
                        Margin="370,119,0,0"
                        VerticalAlignment="Top"
                        Width="366"
                        CornerRadius="10,10,10,10">
                    <Border.Background>
                        <LinearGradientBrush EndPoint="0.5,1"
                                             StartPoint="0.5,0">
                            <GradientStop Color="#FFF6FCFF"
                                          Offset="0.04"/>
                            <GradientStop Color="#FFDBF3FF"
                                          Offset="0.46"/>
                            <GradientStop Color="#FF87ACCD"
                                          Offset="0.937"/>
                        </LinearGradientBrush>
                    </Border.Background>

                    <Grid>
                        <!-- Header với nút tạo nhóm và tìm bạn -->
                        <Grid Height="60"
                              VerticalAlignment="Top">
                            <Button Command="{Binding CreateGroupCommand}"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Margin="0,0,10,0"
                                    Padding="8,5"
                                    Background="#87ACCD"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Content="Tạo nhóm mới"/>

                            <Button Command="{Binding SearchFriendsCommand}"
                                    ToolTip="Tìm bạn bè"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    Margin="15,0,0,0"
                                    Padding="10,5"
                                    Background="#87ACCD"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Content="Tìm bạn bè"/>
                        </Grid>

                        <!-- Danh sách cuộc trò chuyện -->
                        <ScrollViewer Margin="0,60,0,0"
                                      VerticalScrollBarVisibility="Auto">
                            <ListView ItemsSource="{Binding Conversations}"
                                      SelectedItem="{Binding SelectedConversation}"
                                      Background="Transparent"
                                      BorderThickness="0"
                                      Width="340"
                                      Margin="15,0">

                                <!-- Thêm style ở đây -->
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="Padding"
                                                Value="0"/>
                                        <Setter Property="Background"
                                                Value="Transparent"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="{x:Type ListViewItem}">
                                                    <Border x:Name="Border"
                                                            Background="{TemplateBinding Background}"
                                                            BorderThickness="0"
                                                            SnapsToDevicePixels="True"
                                                            CornerRadius="10">
                                                        <Grid>
                                                            <ContentPresenter/>
                                                        </Grid>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver"
                                                                 Value="True">
                                                            <Setter TargetName="Border"
                                                                    Property="Background"
                                                                    Value="#E5F1FF"/>
                                                            <Setter TargetName="Border"
                                                                    Property="Effect">
                                                                <Setter.Value>
                                                                    <DropShadowEffect BlurRadius="5"
                                                                                      ShadowDepth="1"
                                                                                      Opacity="0.2"
                                                                                      Color="#000000"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Trigger>
                                                        <Trigger Property="IsSelected"
                                                                 Value="True">
                                                            <Setter TargetName="Border"
                                                                    Property="Background"
                                                                    Value="#D2E5FF"/>
                                                            <Setter TargetName="Border"
                                                                    Property="Effect">
                                                                <Setter.Value>
                                                                    <DropShadowEffect BlurRadius="5"
                                                                                      ShadowDepth="1"
                                                                                      Opacity="0.2"
                                                                                      Color="#000000"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Height="70"
                                                Width="336"
                                                Background="#FFDAE9F6"
                                                CornerRadius="10"
                                                Margin="0,5">
                                            <Grid>
                                                <Image Height="44"
                                                       Width="44"
                                                       Margin="10,0,0,0"
                                                       HorizontalAlignment="Left"
                                                       VerticalAlignment="Center"
                                                       Source="/Views/Images/account_circle.png"/>
                                                <Label Content="{Binding Converter={StaticResource ConversationTitleConverter}}"
                                                       Margin="60,10,0,0"
                                                       HorizontalAlignment="Left"
                                                       VerticalAlignment="Top"/>
                                                <Label Content="{Binding LastActivity, Converter={StaticResource TimeZoneConverter}, ConverterParameter='HH:mm'}"
                                                       Margin="0,10,10,0"
                                                       FontSize="10"
                                                       HorizontalAlignment="Right"
                                                       VerticalAlignment="Top"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </ScrollViewer>
                    </Grid>
                </Border>
                <!-- Chat Box Container -->
                <Border HorizontalAlignment="Left"
                        Height="864"
                        Margin="764,119,0,0"
                        VerticalAlignment="Top"
                        Width="634"
                        CornerRadius="10,10,10,10">
                    <Border.Background>
                        <LinearGradientBrush EndPoint="0.5,1"
                                             StartPoint="0.5,0">
                            <GradientStop Color="#FF87ACCD"
                                          Offset="1"/>
                            <GradientStop Color="#FFDBF3FF"
                                          Offset="0.46"/>
                            <GradientStop Color="#FFDBF3FF"
                                          Offset="0.54"/>
                            <GradientStop Color="#FF87ACCD"
                                          Offset="0"/>
                        </LinearGradientBrush>
                    </Border.Background>


                    <!-- Nội dung chat -->
                    <Grid>
                        <!-- ChatBox Background -->
                        <Border Margin="29,24,29,24"
                                Background="White"
                                CornerRadius="20,20,20,20">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Header - Simplified -->
                                <Border Grid.Row="0"
                                        Height="56"
                                        Background="#FFDAE9F6"
                                        CornerRadius="20,20,0,0">
                                    <Grid>
                                        <StackPanel Orientation="Horizontal"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Left"
                                                    Margin="26,0,0,0">
                                            <Image Height="30"
                                                   Width="30"
                                                   Source="/Views/Images/account_circle.png"/>
                                            <Label Content="{Binding SelectedConversation, Converter={StaticResource ConversationTitleConverter}}"
                                                   Margin="13,0,0,0"
                                                   FontSize="15"/>
                                        </StackPanel>

                                        <Button Command="{Binding ShowGroupDetailCommand}"
                                                HorizontalAlignment="Right"
                                                Width="30"
                                                Height="30"
                                                Margin="0,0,15,0"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Visibility="{Binding SelectedConversation.IsGroup, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <Image Source="/Views/Images/more_vert.png"
                                                   Width="20"
                                                   Height="20"/>
                                        </Button>
                                    </Grid>
                                </Border>
                                <Border Grid.Row="1"
                                        Width="200"
                                        Background="#FFDAE9F6"
                                        Margin="0,0,0,0"
                                        CornerRadius="10"
                                        HorizontalAlignment="Right"
                                        Visibility="{Binding IsGroupDetailVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                                        Panel.ZIndex="10">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0"
                                                   Text="Thành viên nhóm"
                                                   FontWeight="Bold"
                                                   Margin="10,10,0,5"/>

                                        <ListBox Grid.Row="1"
                                                 ItemsSource="{Binding GroupMembers}"
                                                 BorderThickness="0"
                                                 Background="Transparent">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>

                                                        <StackPanel Grid.Column="0"
                                                                    Orientation="Horizontal">
                                                            <Image Source="/Views/Images/account_circle.png"
                                                                   Width="24"
                                                                   Height="24"
                                                                   Margin="0,0,5,0"/>
                                                            <TextBlock Text="{Binding DisplayName}"
                                                                       VerticalAlignment="Center"/>
                                                        </StackPanel>

                                                        <Button Grid.Column="1"
                                                                Content="×"
                                                                Padding="5,0"
                                                                Margin="5,0,0,0"
                                                                Command="{Binding RemoveUserFromGroupCommand,
                                         RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                CommandParameter="{Binding}"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </Grid>
                                </Border>
                                <!-- Messages Area -->
                                <ScrollViewer Grid.Row="1"
                                              x:Name="MessageScrollViewer"
                                              VerticalScrollBarVisibility="Auto"
                                              Margin="0,5">
                                    <ItemsControl ItemsSource="{Binding Messages}">
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Opacity"
                                                        Value="0"/>
                                                <Setter Property="RenderTransform">
                                                    <Setter.Value>
                                                        <TranslateTransform X="0"
                                                                            Y="20"/>
                                                    </Setter.Value>
                                                </Setter>
                                                <Style.Triggers>
                                                    <EventTrigger RoutedEvent="Loaded">
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation
                                                                    Storyboard.TargetProperty="Opacity"
                                                                    To="1"
                                                                    Duration="0:0:0.3"/>
                                                                <DoubleAnimation
                                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                                                                    To="0"
                                                                    Duration="0:0:0.3">
                                                                    <DoubleAnimation.EasingFunction>
                                                                        <QuadraticEase EasingMode="EaseOut"/>
                                                                    </DoubleAnimation.EasingFunction>
                                                                </DoubleAnimation>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </EventTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Margin="10,5">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Tin nhắn hệ thống -->
                                                    <Border Grid.Column="0"
                                                            Grid.ColumnSpan="2"
                                                            Background="#FFE8E8E8"
                                                            CornerRadius="10"
                                                            Padding="10,5"
                                                            HorizontalAlignment="Center"
                                                            Visibility="{Binding Type, Converter={StaticResource MessageTypeToVisibilityConverter}, ConverterParameter='system'}">
                                                        <TextBlock Text="{Binding Content}"
                                                                   TextWrapping="Wrap"
                                                                   FontStyle="Italic"
                                                                   Foreground="#FF666666"/>
                                                    </Border>

                                                    <!-- Tin nhắn từ người khác -->
                                                    <Border Grid.Column="0"
                                                            Background="#FFB9D4EB"
                                                            CornerRadius="20,20,20,5"
                                                            Padding="15,10"
                                                            MaxWidth="275"
                                                            HorizontalAlignment="Left"
                                                            Visibility="{Binding SenderId, Converter={StaticResource NotCurrentUserConverter}}">
                                                        <Border.ContextMenu>
                                                            <ContextMenu>
                                                                <MenuItem Header="Xóa tin nhắn"
                                                                          Command="{Binding DataContext.DeleteMessageCommand, 
                   RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ItemsControl}}}"
                                                                          CommandParameter="{Binding}"/>
                                                            </ContextMenu>
                                                        </Border.ContextMenu>
                                                        <StackPanel>
                                                            <!-- Nội dung text -->
                                                            <TextBlock Text="{Binding Content}"
                                                                       TextWrapping="Wrap"
                                                                       Visibility="{Binding Content, Converter={StaticResource StringToBoolConverter}, ConverterParameter=Visibility}"/>

                                                            <!-- Hiển thị hình ảnh và files -->
                                                            <ItemsControl ItemsSource="{Binding Attachments}"
                                                                          Margin="0,5,0,0">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <!-- Hình ảnh -->
                                                                        <StackPanel>
                                                                            <Image Source="{Binding FileUrl}"
                                                                                   MaxHeight="150"
                                                                                   MaxWidth="200"
                                                                                   Stretch="Uniform"
                                                                                   HorizontalAlignment="Left"
                                                                                   Visibility="{Binding IsImage, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                                   Margin="0,5,0,5"/>

                                                                            <!-- Files -->
                                                                            <Border Background="#FFF0F0F0"
                                                                                    Margin="0,5,0,0"
                                                                                    Padding="5"
                                                                                    CornerRadius="5"
                                                                                    Visibility="{Binding IsImage, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                                                                                <Grid>
                                                                                    <Grid.ColumnDefinitions>
                                                                                        <ColumnDefinition Width="Auto"/>
                                                                                        <ColumnDefinition Width="*"/>
                                                                                    </Grid.ColumnDefinitions>

                                                                                    <TextBlock Grid.Column="0"
                                                                                               Text="{Binding FileName, Converter={StaticResource FileIconConverter}}"
                                                                                               Width="24"
                                                                                               Height="24"
                                                                                               Margin="0,0,5,0"
                                                                                               TextAlignment="Center"
                                                                                               VerticalAlignment="Center"
                                                                                               FontWeight="Bold"
                                                                                               Background="#FFE0E0FF"/>

                                                                                    <StackPanel Grid.Column="1">
                                                                                        <TextBlock Text="{Binding FileName}"
                                                                                                   TextWrapping="Wrap"
                                                                                                   FontWeight="SemiBold"/>
                                                                                        <TextBlock Text="{Binding FileSize, Converter={StaticResource FileSizeConverter}}"
                                                                                                   Foreground="#FF666666"
                                                                                                   FontSize="10"/>
                                                                                    </StackPanel>
                                                                                </Grid>
                                                                            </Border>
                                                                        </StackPanel>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>

                                                            <!-- Timestamp -->
                                                            <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}"
                                                                       FontSize="10"
                                                                       HorizontalAlignment="Right"
                                                                       Margin="0,5,0,0"/>
                                                        </StackPanel>
                                                    </Border>

                                                    <!-- Tin nhắn từ user hiện tại -->
                                                    <Border Grid.Column="1"
                                                            Background="#FFD5E0E9"
                                                            CornerRadius="20,20,5,20"
                                                            Padding="15,10"
                                                            MaxWidth="275"
                                                            HorizontalAlignment="Right"
                                                            Visibility="{Binding SenderId, Converter={StaticResource CurrentUserConverter}}">
                                                        <Border.ContextMenu>
                                                            <ContextMenu>
                                                                <MenuItem Header="Xóa tin nhắn"
                                                                          Command="{Binding DataContext.DeleteMessageCommand, 
                   RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ItemsControl}}}"
                                                                          CommandParameter="{Binding}"/>
                                                            </ContextMenu>
                                                        </Border.ContextMenu>
                                                        <StackPanel>
                                                            <!-- Nội dung text -->
                                                            <TextBlock Text="{Binding Content}"
                                                                       TextWrapping="Wrap"
                                                                       Visibility="{Binding Content, Converter={StaticResource StringToBoolConverter}, ConverterParameter=Visibility}"/>

                                                            <!-- Hiển thị hình ảnh và files -->
                                                            <ItemsControl ItemsSource="{Binding Attachments}"
                                                                          Margin="0,5,0,0">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <!-- Hình ảnh -->
                                                                        <StackPanel>
                                                                            <Image Source="{Binding FileUrl}"
                                                                                   MaxHeight="150"
                                                                                   MaxWidth="200"
                                                                                   Stretch="Uniform"
                                                                                   HorizontalAlignment="Left"
                                                                                   Visibility="{Binding IsImage, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                                   Margin="0,5,0,5"/>

                                                                            <!-- Files -->
                                                                            <Border Background="#FFF0F0F0"
                                                                                    Margin="0,5,0,0"
                                                                                    Padding="5"
                                                                                    CornerRadius="5"
                                                                                    Visibility="{Binding IsImage, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                                                                                <Grid>
                                                                                    <Grid.ColumnDefinitions>
                                                                                        <ColumnDefinition Width="Auto"/>
                                                                                        <ColumnDefinition Width="*"/>
                                                                                    </Grid.ColumnDefinitions>

                                                                                    <TextBlock Grid.Column="0"
                                                                                               Text="{Binding FileName, Converter={StaticResource FileIconConverter}}"
                                                                                               Width="24"
                                                                                               Height="24"
                                                                                               Margin="0,0,5,0"
                                                                                               TextAlignment="Center"
                                                                                               VerticalAlignment="Center"
                                                                                               FontWeight="Bold"
                                                                                               Background="#FFE0E0FF"/>

                                                                                    <StackPanel Grid.Column="1">
                                                                                        <TextBlock Text="{Binding FileName}"
                                                                                                   TextWrapping="Wrap"
                                                                                                   FontWeight="SemiBold"/>
                                                                                        <TextBlock Text="{Binding FileSize, Converter={StaticResource FileSizeConverter}}"
                                                                                                   Foreground="#FF666666"
                                                                                                   FontSize="10"/>
                                                                                    </StackPanel>
                                                                                </Grid>
                                                                            </Border>
                                                                        </StackPanel>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>

                                                            <!-- Timestamp -->
                                                            <TextBlock Text="{Binding Timestamp, Converter={StaticResource TimeZoneConverter}, ConverterParameter='HH:mm'}"
                                                                       FontSize="10"
                                                                       HorizontalAlignment="Right"
                                                                       Margin="0,5,0,0"/>
                                                        </StackPanel>
                                                    </Border>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>

                                <!-- Input Area -->
                                <Grid Grid.Row="2"
                                      Margin="0,5,0,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Panel hiển thị file đính kèm -->
                                    <Border Grid.Row="0"
                                            Background="#F0F5F9"
                                            BorderThickness="0,0,0,1"
                                            BorderBrush="#D0E5F5"
                                            Visibility="{Binding IsAttachmentsPanelOpen, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Disabled"
                                                      MaxHeight="100">
                                            <ItemsControl ItemsSource="{Binding SelectedAttachments}"
                                                          Margin="10">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="#E0EAF5"
                                                                Margin="0,0,10,5"
                                                                CornerRadius="5"
                                                                Padding="5">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>

                                                                <TextBlock Grid.Column="0"
                                                                           Text="📁"
                                                                           Width="16"
                                                                           Height="16"
                                                                           Margin="0,0,5,0"/>
                                                                <TextBlock Grid.Column="1"
                                                                           Text="{Binding FileName}"
                                                                           MaxWidth="100"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                                <Button Grid.Column="2"
                                                                        Content="×"
                                                                        Padding="3,0"
                                                                        Margin="5,0,0,0"
                                                                        Command="{Binding RemoveAttachmentCommand, 
                                                                        RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                        CommandParameter="{Binding}"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Border>

                                    <!-- Input và nút -->
                                    <Border Grid.Row="1"
                                            Height="56"
                                            Background="#FFDAE9F6"
                                            CornerRadius="0,0,20,20">
                                        <Grid>
                                            <StackPanel Orientation="Horizontal"
                                                        VerticalAlignment="Center"
                                                        HorizontalAlignment="Left"
                                                        Margin="10,0,0,0">
                                                <Button Command="{Binding ShowAttachmentsPanelCommand}"
                                                        Width="30"
                                                        Height="30"
                                                        Background="Transparent"
                                                        BorderThickness="0">
                                                    <Image Source="/Views/Images/add_circle.png"
                                                           Width="18"
                                                           Height="18"/>
                                                </Button>

                                                <StackPanel Orientation="Horizontal"
                                                            Margin="15,0,0,0"
                                                            Visibility="{Binding IsAttachmentsPanelOpen, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <Button Command="{Binding SelectImageCommand}"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Margin="0,0,10,0"
                                                            ToolTip="Thêm hình ảnh">
                                                        <Image Source="/Views/Images/image.png"
                                                               Width="18"
                                                               Height="18"/>
                                                    </Button>
                                                    <Button Command="{Binding SelectFileCommand}"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            ToolTip="Thêm file">
                                                        <Image Source="/Views/Images/document.png"
                                                               Width="18"
                                                               Height="18"/>
                                                    </Button>
                                                </StackPanel>
                                            </StackPanel>
                                            <TextBox Text="{Binding CurrentMessage, UpdateSourceTrigger=PropertyChanged}"
                                                     BorderThickness="0"
                                                     Background="Transparent"
                                                     Margin="80,0,50,0"
                                                     VerticalAlignment="Center"/>

                                            <Button Command="{Binding SendMessageCommand}"
                                                    HorizontalAlignment="Right"
                                                    Width="40"
                                                    Height="40"
                                                    Margin="0,0,10,0"
                                                    Style="{StaticResource SendButtonStyle}">
                                                <Image Source="/Views/Images/send.png"
                                                       Width="19"
                                                       Height="24"/>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
                <!-- Add this closing tag for the Chat Box Container -->
            </Grid>
        </Viewbox>
    </Grid>
</Window>